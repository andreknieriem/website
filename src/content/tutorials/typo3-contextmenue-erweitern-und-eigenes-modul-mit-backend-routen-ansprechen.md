---
title: 'TYPO3: Contextmenü erweitern und eigenes Modul mit Backend-Routen ansprechen'
date: '2017-09-19T22:00:00.000Z'
slug: typo3-contextmenue-erweitern-und-eigenes-modul-mit-backend-routen-ansprechen
tags:
  - typo3
  - contextmenu
  - contectmenü
  - modul
  - backend
  - be
  - file
  - dateiliste
  - '8'
  - lts
  - '7'
description: "In diesem Tutorial geht es darum das Kontextmenü im Modul Dateiliste in TYPO3 8.7LTS zu erweitern und bei Klick auf eben diesen Eintrag im Menü ein eigenes Modul zu laden.\r\nAuf der TYPO3 Seite gibt es schon ein wenig Dokumentation bei der ich mich bedient habe, hier zeige ich aber den kompletten Weg auf.\r\n1. Kontextmenü erweitern\r\nAls erstes fügt man in der ext_localconf eurer Extension zwei Zeilen ein, die das Kontextmenü ansprechen und benötigtes Javascript ins Backend einfügen.\r\next_localconf.php // Add Context Menu and JS\r\nif (TYPO3_MODE=='BE') {\r\n  $GLOBALS['TYPO3_CONF_VARS']['BE']['ContextMenu']['ItemProviders'][1505197586] = \\AR\\ArExt\\ContextMenu\\Mymodule::class;\r\n}\r\n$GLOBALS['TYPO3_CONF_VARS']['SC_OPTIONS']['typo3/backend.php']['constructPostProcess'][] = \\AR\\ArExt\\Hooks\\BackendControllerHook::class . '-&gt;addJavaScript'; Nun müssen natürlich die beiden Dateien, die dort angesprochen werden angelegt werden. Fangen wir mit der \\AR\\ArExt\\ContextMenu\\Mymodule an.&nbsp;\r\nClasses/ContextMenu/Mymodule.php &lt;?php\r\nnamespace AR\\ArExt\\ContextMenu;\r\n\r\nclass Mymodule extends \\TYPO3\\CMS\\Backend\\ContextMenu\\ItemProviders\\AbstractProvider{\r\n\r\n  protected $itemsConfiguration = [\r\n    'filetest' =&gt; [\r\n      'type' =&gt; 'item',\r\n      'label' =&gt; 'File Test Module', // you can use \"LLL:\" syntax here\r\n      'iconIdentifier' =&gt; 'actions-document-open',\r\n      'callbackAction' =&gt; 'fileTest' // Hier die fileTest beachten! Diese Funktion taucht unten in der ContextMenuActions.js wieder auf\r\n    ]\r\n  ];\r\n\r\n  /**\r\n   * Checks if this provider may be called to provide the list of context menu items for given table.\r\n   *\r\n   * @return bool\r\n   */\r\n  public function canHandle(): bool\r\n  {\r\n    // Current table is: $this-&gt;table\r\n    // Current UID is: $this-&gt;identifier\r\n    return $this-&gt;table === 'sys_file';\r\n  }\r\n\r\n  /**\r\n   * Returns the provider priority which is used for determining the order in which providers are processing items\r\n   * to the result array. Highest priority means provider is evaluated first.\r\n   *\r\n   * This item provider should be called after PageProvider which has priority 100.\r\n   *\r\n   * BEWARE: Returned priority should logically not clash with another provider.\r\n   *   Please check @see \\TYPO3\\CMS\\Backend\\ContextMenu\\ContextMenu::getAvailableProviders() if needed.\r\n   *\r\n   * @return int\r\n   */\r\n  public function getPriority(): int\r\n  {\r\n    return 90;\r\n  }\r\n\r\n  /**\r\n   * Registers the additional JavaScript RequireJS callback-module which will allow to display a notification\r\n   * whenever the user tries to click on the \"Hello World\" item.\r\n   * The method is called from AbstractProvider::prepareItems() for each context menu item.\r\n   *\r\n   * @param string $itemName\r\n   * @return array\r\n   */\r\n  protected function getAdditionalAttributes(string $itemName): array\r\n  {\r\n    return [\r\n      // BEWARE!!! RequireJS MODULES MUST ALWAYS START WITH \"TYPO3/CMS/\" (and no \"Vendor\" segment here)\r\n      'data-callback-module' =&gt; 'TYPO3/CMS/ArExt/ContextMenuActions',\r\n      // Here you can also add any other useful \"data-\" attribute you'd like to use in your JavaScript (e.g. localized messages)\r\n    ];\r\n  }\r\n\r\n  /**\r\n   * This method adds custom item to list of items generated by item providers with higher priority value (PageProvider)\r\n   * You could also modify existing items here.\r\n   * The new item is added after the 'info' item.\r\n   *\r\n   * @param array $items\r\n   * @return array\r\n   */\r\n  public function addItems(array $items): array\r\n  {\r\n\r\n    $this-&gt;initDisabledItems();\r\n    $localItems = $this-&gt;prepareItems($this-&gt;itemsConfiguration);\r\n    $items = $items + $localItems;\r\n    //passes array of items to the next item provider\r\n    return $items;\r\n  }\r\n\r\n  /**\r\n   * This method is called for each item this provider adds and checks if given item can be added\r\n   *\r\n   * @param string $itemName\r\n   * @param string $type\r\n   * @return bool\r\n   */\r\n  protected function canRender(string $itemName, string $type): bool\r\n  {\r\n    // checking if item is disabled through TSConfig\r\n    if (in_array($itemName, $this-&gt;disabledItems, true)) {\r\n      return false;\r\n    }\r\n    $canRender = false;\r\n    switch ($itemName) {\r\n      case 'filetest':\r\n      $canRender = true;\r\n      break;\r\n      default:\r\n        $canRender = false;\r\n    }\r\n    return $canRender;\r\n  }\r\n}\r\n Kommen wir nun zur zweiten genannten Datei, die etwas Javascript für das Backend ergänzt.\r\nClasses/Hooks/BackendControllerHook.php &lt;?php\r\nnamespace AR\\ArExt\\Hooks;\r\n\r\nuse TYPO3\\CMS\\Backend\\Controller\\BackendController;\r\nuse TYPO3\\CMS\\Backend\\Utility\\BackendUtility;\r\nuse TYPO3\\CMS\\Core\\Page\\PageRenderer;\r\nuse TYPO3\\CMS\\Core\\Utility\\GeneralUtility;\r\n\r\n/**\r\n * This class adds Filelist related JavaScript to the backend\r\n */\r\nclass BackendControllerHook\r\n{\r\n    /**\r\n     * Adds Filelist JavaScript used e.g. by context menu\r\n     *\r\n     * @param array $configuration\r\n     * @param BackendController $backendController\r\n     */\r\n    public function addJavaScript(array $configuration, BackendController $backendController)\r\n    {\r\n        $pageRenderer = GeneralUtility::makeInstance(PageRenderer::class);\r\n        $pageRenderer-&gt;addInlineSetting('FileTest', 'moduleUrl', BackendUtility::getModuleUrl('file_test'));\r\n    }\r\n}\r\n Als nächstes müssen wir, wie in der Doku von TYPO3 beschrieben noch eine Javascript an folgende Stelle tun:\r\nEXT:extension_key/Resources/Public/JavaScript/ContextMenuActions.js /**\r\n * Module: TYPO3/CMS/ExtensionKey/ContextMenuActions\r\n *\r\n * JavaScript to handle the click action of the \"Hello World\" context menu item\r\n * @exports TYPO3/CMS/ExtensionKey/ContextMenuActions\r\n */\r\ndefine(function () {\r\n  'use strict';\r\n\r\n  /**\r\n   * @exports TYPO3/CMS/ExtensionKey/ContextMenuActions\r\n   */\r\n  var ContextMenuActions = {};\r\n\r\n  /**\r\n   * Say hello\r\n   *\r\n   * @param {string} table\r\n   * @param {int} uid of the page\r\n   */\r\n\r\n    ContextMenuActions.getReturnUrl = function () {\r\n      return top.rawurlencode(top.list_frame.document.location.pathname + top.list_frame.document.location.search);\r\n    };\r\n\r\n    ContextMenuActions.fileTest = function (table, uid) { // Hier die fileTest beachten! Diese Funktion haben wir in der ContextMenu Klasse unter callback definiert!\r\n      if (table === 'sys_file') {\r\n        //If needed, you can access other 'data' attributes here from $(this).data('someKey')\r\n        //see item provider getAdditionalAttributes method to see how to pass custom data attributes\r\n        // hier springen wir auf das module FileTest\r\n        top.TYPO3.Backend.ContentContainer.setUrl(\r\n          top.TYPO3.settings.FileTest.moduleUrl + '&amp;target=' + top.rawurlencode(uid) + '&amp;returnUrl=' + ContextMenuActions.getReturnUrl()\r\n        );\r\n      }\r\n    };\r\n    return ContextMenuActions;\r\n}); Wenn wir so weit sind, dann kommt nun schon unser Punkt im Kontext-Menü und man kann ihn klicken. Danach kommt man allerdings noch nicht weiter, da das Backend die Route file_test noch nicht kennt.\r\nEine Route definiert man, in dem man Configuration/Backend/Routes.php anlegt. &lt;?php\r\nuse AR\\ArExt\\Controller;\r\n\r\n/**\r\n * Definitions for routes provided by EXT:backend\r\n * Contains all \"regular\" routes for entry points\r\n *\r\n * Please note that this setup is preliminary until all core use-cases are set up here.\r\n * Especially some more properties regarding modules will be added until TYPO3 CMS 7 LTS, and might change.\r\n *\r\n * Currently the \"access\" property is only used so no token creation + validation is made,\r\n * but will be extended further.\r\n */\r\nreturn [\r\n  //\r\n  'file_test' =&gt; [\r\n    'path' =&gt; '/file/test',\r\n    'target' =&gt; Controller\\FileTestController::class . '::mainAction'\r\n  ],\r\n];\r\n Wie man hier sieht, kann man hier einen belieben Controller und eine beliebige Action laden. In meinem Fall den FileTestController mit der mainAction. Sobald diesen angelegt und auch die passende Action dazu und dort zum Beispiel ein echo 'Test'; hineinschreibt, so wird nach Klick auf den neuen Kontext-Menü Eintrag das Module geladen und es wird Test angezeigt. Ab hier ist es jedem selbst überlassen, was er tun möchte.\r\nIch hoffe ich konnte einen groben Einblick verschaffen, wie man einen Kontext-Menü Eintrag hinzufügt und ein eigenes Modul aufruft."
image: /fileadmin/_processed_/0/a/csm_typo3_81d1ef1672.png
demo_url: null
download_url: null
---

In diesem Tutorial geht es darum das Kontextmenü im Modul Dateiliste in TYPO3 8.7LTS zu erweitern und bei Klick auf eben diesen Eintrag im Menü ein eigenes Modul zu laden.

Auf der [TYPO3 Seite gibt es schon ein wenig Dokumentation](https://docs.typo3.org/typo3cms/CoreApiReference/ApiOverview/Examples/ContextualMenu/Index.html "Opens internal link in current window") bei der ich mich bedient habe, hier zeige ich aber den kompletten Weg auf.

### 1\. Kontextmenü erweitern

Als erstes fügt man in der ext\_localconf eurer Extension zwei Zeilen ein, die das Kontextmenü ansprechen und benötigtes Javascript ins Backend einfügen.

**ext\_localconf.php**

```php
// Add Context Menu and JS
if (TYPO3_MODE=='BE') {
  $GLOBALS['TYPO3_CONF_VARS']['BE']['ContextMenu']['ItemProviders'][1505197586] = \AR\ArExt\ContextMenu\Mymodule::class;
}
$GLOBALS['TYPO3_CONF_VARS']['SC_OPTIONS']['typo3/backend.php']['constructPostProcess'][] = \AR\ArExt\Hooks\BackendControllerHook::class . '->addJavaScript';
```

Nun müssen natürlich die beiden Dateien, die dort angesprochen werden angelegt werden. Fangen wir mit der **\\AR\\ArExt\\ContextMenu\\Mymodule** an. 

**Classes/ContextMenu/Mymodule.php**

```php
<?php
namespace AR\ArExt\ContextMenu;

class Mymodule extends \TYPO3\CMS\Backend\ContextMenu\ItemProviders\AbstractProvider{

  protected $itemsConfiguration = [
    'filetest' => [
      'type' => 'item',
      'label' => 'File Test Module', // you can use "LLL:" syntax here
      'iconIdentifier' => 'actions-document-open',
      'callbackAction' => 'fileTest' // Hier die fileTest beachten! Diese Funktion taucht unten in der ContextMenuActions.js wieder auf
    ]
  ];

  /**
   * Checks if this provider may be called to provide the list of context menu items for given table.
   *
   * @return bool
   */
  public function canHandle(): bool
  {
    // Current table is: $this->table
    // Current UID is: $this->identifier
    return $this->table === 'sys_file';
  }

  /**
   * Returns the provider priority which is used for determining the order in which providers are processing items
   * to the result array. Highest priority means provider is evaluated first.
   *
   * This item provider should be called after PageProvider which has priority 100.
   *
   * BEWARE: Returned priority should logically not clash with another provider.
   *   Please check @see \TYPO3\CMS\Backend\ContextMenu\ContextMenu::getAvailableProviders() if needed.
   *
   * @return int
   */
  public function getPriority(): int
  {
    return 90;
  }

  /**
   * Registers the additional JavaScript RequireJS callback-module which will allow to display a notification
   * whenever the user tries to click on the "Hello World" item.
   * The method is called from AbstractProvider::prepareItems() for each context menu item.
   *
   * @param string $itemName
   * @return array
   */
  protected function getAdditionalAttributes(string $itemName): array
  {
    return [
      // BEWARE!!! RequireJS MODULES MUST ALWAYS START WITH "TYPO3/CMS/" (and no "Vendor" segment here)
      'data-callback-module' => 'TYPO3/CMS/ArExt/ContextMenuActions',
      // Here you can also add any other useful "data-" attribute you'd like to use in your JavaScript (e.g. localized messages)
    ];
  }

  /**
   * This method adds custom item to list of items generated by item providers with higher priority value (PageProvider)
   * You could also modify existing items here.
   * The new item is added after the 'info' item.
   *
   * @param array $items
   * @return array
   */
  public function addItems(array $items): array
  {

    $this->initDisabledItems();
    $localItems = $this->prepareItems($this->itemsConfiguration);
    $items = $items + $localItems;
    //passes array of items to the next item provider
    return $items;
  }

  /**
   * This method is called for each item this provider adds and checks if given item can be added
   *
   * @param string $itemName
   * @param string $type
   * @return bool
   */
  protected function canRender(string $itemName, string $type): bool
  {
    // checking if item is disabled through TSConfig
    if (in_array($itemName, $this->disabledItems, true)) {
      return false;
    }
    $canRender = false;
    switch ($itemName) {
      case 'filetest':
      $canRender = true;
      break;
      default:
        $canRender = false;
    }
    return $canRender;
  }
}

```

Kommen wir nun zur zweiten genannten Datei, die etwas Javascript für das Backend ergänzt.

**Classes/Hooks/BackendControllerHook.php**

```php
<?php
namespace AR\ArExt\Hooks;

use TYPO3\CMS\Backend\Controller\BackendController;
use TYPO3\CMS\Backend\Utility\BackendUtility;
use TYPO3\CMS\Core\Page\PageRenderer;
use TYPO3\CMS\Core\Utility\GeneralUtility;

/**
 * This class adds Filelist related JavaScript to the backend
 */
class BackendControllerHook
{
    /**
     * Adds Filelist JavaScript used e.g. by context menu
     *
     * @param array $configuration
     * @param BackendController $backendController
     */
    public function addJavaScript(array $configuration, BackendController $backendController)
    {
        $pageRenderer = GeneralUtility::makeInstance(PageRenderer::class);
        $pageRenderer->addInlineSetting('FileTest', 'moduleUrl', BackendUtility::getModuleUrl('file_test'));
    }
}

```

Als nächstes müssen wir, wie in der Doku von TYPO3 beschrieben noch eine Javascript an folgende Stelle tun:

**EXT:extension\_key/Resources/Public/JavaScript/ContextMenuActions.js**

```javascript
/**
 * Module: TYPO3/CMS/ExtensionKey/ContextMenuActions
 *
 * JavaScript to handle the click action of the "Hello World" context menu item
 * @exports TYPO3/CMS/ExtensionKey/ContextMenuActions
 */
define(function () {
  'use strict';

  /**
   * @exports TYPO3/CMS/ExtensionKey/ContextMenuActions
   */
  var ContextMenuActions = {};

  /**
   * Say hello
   *
   * @param {string} table
   * @param {int} uid of the page
   */

    ContextMenuActions.getReturnUrl = function () {
      return top.rawurlencode(top.list_frame.document.location.pathname + top.list_frame.document.location.search);
    };

    ContextMenuActions.fileTest = function (table, uid) { // Hier die fileTest beachten! Diese Funktion haben wir in der ContextMenu Klasse unter callback definiert!
      if (table === 'sys_file') {
        //If needed, you can access other 'data' attributes here from $(this).data('someKey')
        //see item provider getAdditionalAttributes method to see how to pass custom data attributes
        // hier springen wir auf das module FileTest
        top.TYPO3.Backend.ContentContainer.setUrl(
          top.TYPO3.settings.FileTest.moduleUrl + '&target=' + top.rawurlencode(uid) + '&returnUrl=' + ContextMenuActions.getReturnUrl()
        );
      }
    };
    return ContextMenuActions;
});
```

Wenn wir so weit sind, dann kommt nun schon unser Punkt im Kontext-Menü und man kann ihn klicken. Danach kommt man allerdings noch nicht weiter, da das Backend die Route **file\_test** noch nicht kennt.

Eine Route definiert man, in dem man **Configuration/Backend/Routes.php** anlegt.

```php
<?php
use AR\ArExt\Controller;

/**
 * Definitions for routes provided by EXT:backend
 * Contains all "regular" routes for entry points
 *
 * Please note that this setup is preliminary until all core use-cases are set up here.
 * Especially some more properties regarding modules will be added until TYPO3 CMS 7 LTS, and might change.
 *
 * Currently the "access" property is only used so no token creation + validation is made,
 * but will be extended further.
 */
return [
  //
  'file_test' => [
    'path' => '/file/test',
    'target' => Controller\FileTestController::class . '::mainAction'
  ],
];

```

Wie man hier sieht, kann man hier einen belieben Controller und eine beliebige Action laden. In meinem Fall den **FileTestController** mit der **mainAction**. Sobald diesen angelegt und auch die passende Action dazu und dort zum Beispiel ein echo 'Test'; hineinschreibt, so wird nach Klick auf den neuen Kontext-Menü Eintrag das Module geladen und es wird Test angezeigt. Ab hier ist es jedem selbst überlassen, was er tun möchte.

Ich hoffe ich konnte einen groben Einblick verschaffen, wie man einen Kontext-Menü Eintrag hinzufügt und ein eigenes Modul aufruft.